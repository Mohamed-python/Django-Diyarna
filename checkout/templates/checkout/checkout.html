{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block content %}

<iframe
    src="{{ session_id }}"
    width="100%"
    height="700"
    frameborder="0"
    style="border:none;"
    allowpaymentrequest
></iframe>

<script>
// ðŸ‘‡ Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        document.cookie.split(';').forEach(cookie => {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            }
        });
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// ðŸ‘‡ URL view order_completed
const ORDER_COMPLETED_URL = "{% url 'order_completed' %}";

// ðŸ‘‡ listener Ù„Ù„Ù€ iframe Ù…Ù† Kashier
window.addEventListener("message", function(event) {
    if (!event.origin.includes("kashier.io")) return;

    const response = event.data;
    console.log("Kashier Response:", response);

    const isSuccess =
        response?.message === "success" ||
        response?.response?.result === "SUCCESS" ||
        response?.response?.status === "CAPTURED";

    if (!isSuccess) {
        alert("âŒ ÙØ´Ù„ Ø§Ù„Ø¯ÙØ¹");
        return;
    }

    // ðŸ”¹ Ø¬Ù„Ø¨ cart Ù…Ù† localStorage
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');

    // ðŸ”¹ Ø§Ø±Ø³Ø§Ù„ POST Ù„view order_completed
    fetch(ORDER_COMPLETED_URL, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({cart})
    })
    .then(res => res.json())
    .then(data => {
        console.log("Order Completed Response:", data);

        if (data.status === "success") {
            localStorage.removeItem('cart');
            window.location.href = data.redirect_url;
        } else {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨");
        }
    })
    .catch(err => console.error("Error completing order:", err));
}, false);
</script>

{% endblock %}
