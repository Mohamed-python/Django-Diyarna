{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block extra_css %}
<style>
/* متغيرات الألوان */
:root {
    --primary-color: #02c3eb;
    --primary-dark: #02a8cc;
    --primary-light: rgba(2, 195, 235, 0.1);
    --primary-gradient: linear-gradient(135deg, #02c3eb, #02a8cc);
    --secondary-color: #6c757d;
    --success-color: #28a745;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
    --light-bg: #f8f9fa;
    --white: #ffffff;
    --shadow: 0 8px 25px rgba(2, 195, 235, 0.1);
    --shadow-lg: 0 15px 35px rgba(2, 195, 235, 0.15);
    --radius-lg: 20px;
    --radius-md: 12px;
    --radius-sm: 8px;
    --transition: all 0.3s ease;
}

/* إصلاحات RTL */
[dir="rtl"] {
    text-align: right;
    direction: rtl;

}

[dir="ltr"] {
    text-align: left;
    direction: ltr;
}

[dir="rtl"] .form-control,
[dir="rtl"] .form-select,
[dir="rtl"] textarea {
    text-align: right;
    direction: rtl;
}

[dir="ltr"] .form-control,
[dir="ltr"] .form-select,
[dir="ltr"] textarea {
    text-align: left;
    direction: ltr;
}

[dir="rtl"] .form-control::placeholder,
[dir="rtl"] textarea::placeholder {
    text-align: right;
}

[dir="ltr"] .form-control::placeholder,
[dir="ltr"] textarea::placeholder {
    text-align: left;
}

/* صفحة الدفع */
.checkout-page {
    min-height: 100vh;
    background-color: #002f38;
    padding: 60px 0;

}

/* رسائل الخطأ */
.checkout-alerts {
    max-width: 800px;
    margin: 0 auto 30px;
}

.alert-box {
    border-radius: var(--radius-md);
    padding: 20px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    animation: slideIn 0.5s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.alert-danger {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
}

.alert-danger .alert-icon {
    color: #dc2626;
}

.alert-icon {
    font-size: 24px;
}

.alert-content {
    flex: 1;
}

.alert-content ul {
    margin: 10px 0 0 0;
    padding-right: 20px;
}

[dir="rtl"] .alert-content ul {
    padding-right: 0;
    padding-left: 20px;
}

/* المحتوى الرئيسي */
.checkout-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}

.checkout-title {
    text-align: center;
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 50px;
    position: relative;
    padding-bottom: 20px;
}

.checkout-title::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 4px;
    background: var(--primary-gradient);
    border-radius: 2px;
}

[dir="rtl"] .checkout-title::after {
    left: auto;
    right: 50%;
    transform: translateX(50%);
}

/* الشبكة */
.checkout-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
}

/* ملخص الطلب */
.order-summary-card {
    background: var(--white);
    border-radius: var(--radius-lg);
    padding: 40px;
    box-shadow: var(--shadow);
    height: fit-content;
}

.summary-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--light-bg);
}

.summary-icon {
    width: 50px;
    height: 50px;
    background: var(--primary-light);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-color);
    font-size: 24px;
}

.summary-title {
    font-size: 1.8rem;
    font-weight: 700;
    color: #333;
    margin: 0;
}

/* عناصر السلة */
.cart-items {
    margin-bottom: 30px;
}

.cart-item {
    display: flex;
    align-items: center;
    padding: 20px 0;
    border-bottom: 1px solid var(--light-bg);
}

.cart-item:last-child {
    border-bottom: none;
}

.item-image {
    width: 80px;
    height: 80px;
    border-radius: var(--radius-sm);
    overflow: hidden;
    margin-left: 20px;
    flex-shrink: 0;
}

[dir="rtl"] .item-image {
    margin-left: 0;
    margin-right: 20px;
}

.item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.item-image-placeholder {
    width: 100%;
    height: 100%;
    background: var(--primary-light);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-color);
    font-size: 24px;
}

.item-details {
    flex: 1;
}

.item-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
    font-size: 1.1rem;
}

.item-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
    color: var(--secondary-color);
}

.item-price {
    color: var(--primary-color);
    font-weight: 600;
}

.item-quantity {
    background: var(--light-bg);
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 0.85rem;
}

/* ملخص المبلغ */
.order-totals {
    background: var(--light-bg);
    border-radius: var(--radius-md);
    padding: 25px;
    margin-top: 30px;
}

.total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px dashed #ddd;
}

.total-row:last-child {
    border-bottom: none;
    font-weight: 700;
    font-size: 1.2rem;
    color: var(--primary-color);
}

.total-label {
    color: var(--secondary-color);
}

.total-value {
    font-weight: 600;
    color: #333;
}

/* نموذج الدفع */
.checkout-form-card {
    background: var(--white);
    border-radius: var(--radius-lg);
    padding: 40px;
    box-shadow: var(--shadow);
}

.form-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--light-bg);
}

.form-icon {
    width: 50px;
    height: 50px;
    background: var(--primary-light);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-color);
    font-size: 24px;
}

.form-title {
    font-size: 1.8rem;
    font-weight: 700;
    color: #333;
    margin: 0;
}

.form-subtitle {
    color: var(--secondary-color);
    line-height: 1.6;
    margin-bottom: 30px;
}

/* حقول النموذج */
.form-group-custom {
    margin-bottom: 25px;
}

.form-label-custom {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
    font-size: 1rem;
}

.form-control-custom {
    width: 100%;
    padding: 15px;
    border: 2px solid #e2e8f0;
    border-radius: var(--radius-sm);
    font-size: 1rem;
    transition: var(--transition);
    background: var(--light-bg);
    color: #333;
}

.form-control-custom:focus {
    outline: none;
    border-color: var(--primary-color);
    background: white;
    box-shadow: 0 0 0 3px var(--primary-light);
}

.form-control-custom::placeholder {
    color: #94a3b8;
}

/* نية التبرع */
.donation-intention {
    background: var(--light-bg);
    border-radius: var(--radius-md);
    padding: 25px;
    margin: 30px 0;
    border-left: 4px solid var(--primary-color);
}

[dir="rtl"] .donation-intention {
    border-left: none;
    border-right: 4px solid var(--primary-color);
}

.intention-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
}

.intention-icon {
    color: var(--primary-color);
    font-size: 24px;
}

.intention-title {
    font-weight: 600;
    color: #333;
    font-size: 1.2rem;
    margin: 0;
}

.intention-description {
    color: var(--secondary-color);
    line-height: 1.6;
    margin-bottom: 20px;
    font-size: 0.95rem;
}

.intention-options {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.intention-option {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: var(--radius-sm);
    padding: 15px;
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
}

.intention-option:hover {
    border-color: var(--primary-color);
    transform: translateY(-2px);
}

.intention-option.selected {
    border-color: var(--primary-color);
    background: var(--primary-light);
}

.option-icon {
    font-size: 24px;
    color: var(--primary-color);
    margin-bottom: 10px;
}

.option-text {
    font-weight: 500;
    color: #333;
    font-size: 0.95rem;
}

.intention-textarea {
    width: 100%;
    padding: 15px;
    border: 2px solid #e2e8f0;
    border-radius: var(--radius-sm);
    font-size: 0.95rem;
    transition: var(--transition);
    background: white;
    color: #333;
    resize: vertical;
    min-height: 100px;
    margin-top: 15px;
}

.intention-textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px var(--primary-light);
}

/* زر المتابعة */
.submit-btn {
    width: 100%;
    padding: 18px;
    background: var(--primary-gradient);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
    position: relative;
    overflow: hidden;
}

.submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(2, 195, 235, 0.3);
}

.submit-btn:active {
    transform: translateY(0);
}

.submit-btn i {
    font-size: 20px;
}

.submit-btn.loading i {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* بطاقة المزايا */
.donation-benefits {
    margin-top: 40px;
    padding: 30px;
    background: var(--light-bg);
    border-radius: var(--radius-lg);
    border: 2px solid var(--primary-light);
}

.benefits-title {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.benefits-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.benefit-item {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
    color: var(--secondary-color);
}

.benefit-item i {
    color: var(--primary-color);
    font-size: 18px;
}

/* تصميم متجاوب */
@media (max-width: 992px) {
    .checkout-grid {
        grid-template-columns: 1fr;
        gap: 30px;
    }

    .checkout-title {
        font-size: 2.2rem;
    }

    .order-summary-card,
    .checkout-form-card {
        padding: 30px;
    }
}

@media (max-width: 768px) {
    .checkout-page {
        padding: 40px 0;
    }

    .checkout-title {
        font-size: 1.8rem;
        margin-bottom: 30px;
    }

    .order-summary-card,
    .checkout-form-card {
        padding: 25px;
    }

    .summary-title,
    .form-title {
        font-size: 1.5rem;
    }

    .cart-item {
        /*flex-direction: column;*/
        text-align: center;
    }

    .item-image {
        margin: 0 0 15px 0;
    }

    [dir="rtl"] .item-image {
        margin: 0 0 15px 0;
    }

    .item-meta {
        flex-direction: column;
        gap: 10px;
    }

    .intention-options {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 576px) {
    .checkout-container {
        padding: 0 15px;
    }

    .checkout-title {
        font-size: 1.6rem;
    }

    .order-summary-card,
    .checkout-form-card {
        padding: 20px;
    }
}

/* أنيميشن */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.fade-in-up {
    animation: fadeInUp 0.6s ease forwards;
}
</style>
{% endblock %}

{% block content %}
<div class="checkout-page" dir="{% if LANGUAGE_CODE == 'ar' %}rtl{% else %}ltr{% endif %}">

    <!-- رسائل الخطأ -->
    {% if errors %}
    <div class="checkout-alerts fade-in-up">
        <div class="alert-box alert-danger">
            <div class="alert-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="alert-content">
                <strong>
                    {% if LANGUAGE_CODE == 'ar' %}
                        يرجى تصحيح الأخطاء التالية:
                    {% else %}
                        Please correct the following errors:
                    {% endif %}
                </strong>
                <ul>
                    {% for error in errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="checkout-container">
        {% comment %} <h1 class="checkout-title fade-in-up">
            {% if LANGUAGE_CODE == 'ar' %}
                إتمام عملية التبرع
            {% else %}
                Complete Your Donation
            {% endif %}
        </h1> {% endcomment %}

        <div class="checkout-grid">
            <!-- ملخص الطلب -->
            <div class="order-summary-card fade-in-up" style="animation-delay: 0.2s;">
                <div class="summary-header">
                    <div class="summary-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <h2 class="summary-title">
                        {% if LANGUAGE_CODE == 'ar' %}
                            ملخص التبرع
                        {% else %}
                            Donation summary
                        {% endif %}
                    </h2>
                </div>

                <!-- عناصر السلة -->
                <div class="cart-items" id="cartItems">
                    <!-- سيتم ملؤها بواسطة JavaScript -->
                </div>

                <!-- ملخص المبالغ -->
                <div class="order-totals">
                    <div class="total-row">
                        <span class="total-label">
                            {% if LANGUAGE_CODE == 'ar' %}
                                الإجمالي الجزئي
                            {% else %}
                                Subtotal
                            {% endif %}
                        </span>
                        <span class="total-value" id="subtotal">0.00 EGP</span>
                    </div>
                    <div class="total-row">
                        <span class="total-label">
                            {% if LANGUAGE_CODE == 'ar' %}
                                رسوم الخدمة
                            {% else %}
                                Service Fee
                            {% endif %}
                        </span>
                        <span class="total-value">0.00 EGP</span>
                    </div>
                    <div class="total-row">
                        <span class="total-label">
                            {% if LANGUAGE_CODE == 'ar' %}
                                المبلغ الإجمالي
                            {% else %}
                                Total Amount
                            {% endif %}
                        </span>
                        <span class="total-value" id="totalAmount">0.00 EGP</span>
                    </div>
                </div>

                <!-- مزايا التبرع -->
                <div class="donation-benefits fade-in-up" style="animation-delay: 0.4s;">
                    <h3 class="benefits-title">
                        <i class="fas fa-gift"></i>
                        {% if LANGUAGE_CODE == 'ar' %}
                            فوائد تبرعك
                        {% else %}
                            Benefits of Your Donation
                        {% endif %}
                    </h3>
                    <ul class="benefits-list">
                        <li class="benefit-item">
                            <i class="fas fa-check-circle"></i>
                            {% if LANGUAGE_CODE == 'ar' %}
                                جميع تبرعاتك معفاة من الضرائب
                            {% else %}
                                All donations are tax-deductible
                            {% endif %}
                        </li>
                        <li class="benefit-item">
                            <i class="fas fa-check-circle"></i>
                            {% if LANGUAGE_CODE == 'ar' %}
                                شهادة تبرع إلكترونية
                            {% else %}
                                Electronic donation certificate
                            {% endif %}
                        </li>
                        <li class="benefit-item">
                            <i class="fas fa-check-circle"></i>
                            {% if LANGUAGE_CODE == 'ar' %}
                                تحديثات دورية عن الحالات
                            {% else %}
                                Regular updates on cases
                            {% endif %}
                        </li>
                        <li class="benefit-item">
                            <i class="fas fa-check-circle"></i>
                            {% if LANGUAGE_CODE == 'ar' %}
                                شفافية كاملة في توزيع التبرعات
                            {% else %}
                                Full transparency in donation distribution
                            {% endif %}
                        </li>
                    </ul>
                </div>
            </div>

            <!-- نموذج الدفع -->
            <div class="checkout-form-card fade-in-up" style="animation-delay: 0.3s;">
                <div class="form-header">
                    <div class="form-icon">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <h2 class="form-title">
                        {% if LANGUAGE_CODE == 'ar' %}
                            بيانات المتبرع
                        {% else %}
                            Donor Information
                        {% endif %}
                    </h2>
                </div>

                <p class="form-subtitle">
                    {% if LANGUAGE_CODE == 'ar' %}
                        يرجى ملء المعلومات التالية لإتمام عملية التبرع
                    {% else %}
                        Please fill in the following information to complete your donation
                    {% endif %}
                </p>

                <form method="POST" action="{% url 'start_payment' %}" id="checkoutForm">
                    {% csrf_token %}

                    <!-- البيانات الشخصية -->
                    <div class="form-group-custom">
                        <label for="donorName" class="form-label-custom">
                            {% if LANGUAGE_CODE == 'ar' %}
                                الاسم الكامل
                            {% else %}
                                Full Name
                            {% endif %} *
                        </label>
                        <input type="text"
                               id="donorName"
                               name="name"
                               class="form-control-custom"
                               placeholder="{% if LANGUAGE_CODE == 'ar' %}أدخل اسمك الكامل{% else %}Enter your full name{% endif %}"
                               required>
                    </div>

                    <div class="form-group-custom">
                        <label for="donorEmail" class="form-label-custom">
                            {% if LANGUAGE_CODE == 'ar' %}
                                البريد الإلكتروني
                            {% else %}
                                Email Address
                            {% endif %} *
                        </label>
                        <input type="email"
                               id="donorEmail"
                               name="email"
                               class="form-control-custom"
                               placeholder="{% if LANGUAGE_CODE == 'ar' %}example@mail.com{% else %}example@mail.com{% endif %}"
                               required>
                    </div>

                    <div class="form-group-custom">
                        <label for="donorPhone" class="form-label-custom">
                            {% if LANGUAGE_CODE == 'ar' %}
                                رقم الهاتف
                            {% else %}
                                Phone Number
                            {% endif %} *
                        </label>
                        <input type="tel"
                               id="donorPhone"
                               name="phone"
                               class="form-control-custom"
                               placeholder="{% if LANGUAGE_CODE == 'ar' %}01012345678{% else %}01012345678{% endif %}"
                               required>
                    </div>

                    <!-- نية التبرع -->
                    <div class="donation-intention fade-in-up" style="animation-delay: 0.4s;">
                        <div class="intention-header">
                            <div class="intention-icon">
                                <i class="fas fa-heart"></i>
                            </div>
                            <h3 class="intention-title">
                                {% if LANGUAGE_CODE == 'ar' %}
                                    نية التبرع (اختياري)
                                {% else %}
                                    Donation Intention (Optional)
                                {% endif %}
                            </h3>
                        </div>
                        <p class="intention-description">
                            {% if LANGUAGE_CODE == 'ar' %}
                                اختر نية تبرعك أو اكتب نيتك الخاصة. هذه المعلومة للاستخدام الداخلي فقط ولن تظهر للعلن.
                            {% else %}
                                Choose your donation intention or write your own. This information is for internal use only and will not be made public.
                            {% endif %}
                        </p>

                        <div class="intention-options">
                            <div class="intention-option" data-intention="general">
                                <div class="option-icon">
                                    <i class="fas fa-hands-helping"></i>
                                </div>
                                <div class="option-text">
                                    {% if LANGUAGE_CODE == 'ar' %}
                                        مساعدة عامة
                                    {% else %}
                                        General Assistance
                                    {% endif %}
                                </div>
                            </div>

                            <div class="intention-option" data-intention="health">
                                <div class="option-icon">
                                    <i class="fas fa-heartbeat"></i>
                                </div>
                                <div class="option-text">
                                    {% if LANGUAGE_CODE == 'ar' %}
                                        علاج مريض
                                    {% else %}
                                        Patient Treatment
                                    {% endif %}
                                </div>
                            </div>

                            <div class="intention-option" data-intention="education">
                                <div class="option-icon">
                                    <i class="fas fa-graduation-cap"></i>
                                </div>
                                <div class="option-text">
                                    {% if LANGUAGE_CODE == 'ar' %}
                                        مساعدة طالب
                                    {% else %}
                                        Student Assistance
                                    {% endif %}
                                </div>
                            </div>

                            <div class="intention-option" data-intention="custom">
                                <div class="option-icon">
                                    <i class="fas fa-edit"></i>
                                </div>
                                <div class="option-text">
                                    {% if LANGUAGE_CODE == 'ar' %}
                                        نية خاصة
                                    {% else %}
                                        Custom Intention
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <textarea name="intention"
                                  id="customIntention"
                                  class="intention-textarea"
                                  placeholder="{% if LANGUAGE_CODE == 'ar' %}اكتب نية تبرعك هنا...{% else %}Write your donation intention here...{% endif %}"
                                  style="display: none;"></textarea>
                        <input type="hidden" name="intention_type" id="intentionType" value="">
                    </div>

                    <!-- المبلغ الإجمالي -->
                    <div class="form-group-custom">
                        <label for="totalAmountInput" class="form-label-custom">
                            {% if LANGUAGE_CODE == 'ar' %}
                                إجمالي التبرع
                            {% else %}
                                Total Donation
                            {% endif %} *
                        </label>
                        <input type="number" id="totalAmountInput" name="amount" class="form-control-custom text-center"
                               min="1"
                               required
                               readonly>
                    </div>

                    <!-- بيانات السلة المخفية -->
                    <input type="hidden" name="cart_data" id="cartData">

                    <!-- زر المتابعة -->
                    <button type="submit" class="submit-btn" id="submitBtn">
                        <span>
                            {% if LANGUAGE_CODE == 'ar' %}
                                متابعة الدفع
                            {% else %}
                                Proceed to Payment
                            {% endif %}
                        </span>
                        <i class="fas fa-arrow-right"></i>
                    </button>

                    <!-- سياسة الخصوصية -->
                    <p class="text-center mt-3" style="color: var(--secondary-color); font-size: 0.9rem;">
                        {% if LANGUAGE_CODE == 'ar' %}
                            بالنقر على "متابعة الدفع" فإنك توافق على
                            <a href="" style="color: var(--primary-color);">شروط الخدمة وسياسة الخصوصية</a>
                        {% else %}
                            By clicking "Proceed to Payment" you agree to our
                            <a href="" style="color: var(--primary-color);">Terms of Service & Privacy Policy</a>
                        {% endif %}
                    </p>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const isRTL = '{{ LANGUAGE_CODE }}' === 'ar';

    // عناصر DOM
    const cartItemsContainer = document.getElementById('cartItems');
    const subtotalElement = document.getElementById('subtotal');
    const totalAmountElement = document.getElementById('totalAmount');
    const totalAmountInput = document.getElementById('totalAmountInput');
    const cartDataInput = document.getElementById('cartData');
    const checkoutForm = document.getElementById('checkoutForm');
    const submitBtn = document.getElementById('submitBtn');

    // عناصر نية التبرع
    const intentionOptions = document.querySelectorAll('.intention-option');
    const customIntentionTextarea = document.getElementById('customIntention');
    const intentionTypeInput = document.getElementById('intentionType');

    // جلب بيانات السلة
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');

    // ترجمة أنواع التبرع
    const intentionTranslations = {
        'general': isRTL ? 'مساعدة عامة' : 'General Assistance',
        'health': isRTL ? 'علاج مريض' : 'Patient Treatment',
        'education': isRTL ? 'مساعدة طالب' : 'Student Assistance',
        'custom': isRTL ? 'نية خاصة' : 'Custom Intention'
    };

    // تحديث ملخص الطلب
    function updateOrderSummary() {
        let subtotal = 0;
        let cartItemsHTML = '';

        if (cart.length === 0) {
            cartItemsHTML = `
                <div class="empty-cart text-center py-4">
                    <i class="fas fa-shopping-cart fa-3x mb-3" style="color: #ccc;"></i>
                    <p style="color: var(--secondary-color);">
                        ${isRTL ? 'السلة فارغة' : 'Your cart is empty'}
                    </p>
                </div>
            `;
        } else {
            cart.forEach((item, index) => {
                const itemTotal = (item.price || 0) * (item.quantity || 1);
                subtotal += itemTotal;

                cartItemsHTML += `
                    <div class="cart-item">
                        <div class="item-image">
                            ${item.img ?
                                `<img src="${item.img}" alt="${item.name}">` :
                                `<div class="item-image-placeholder">
                                    <i class="fas fa-${item.type === 'cases' ? 'heart' : 'box'}"></i>
                                </div>`
                            }
                        </div>
                        <div class="item-details">
                            <div class="item-name">${item.name}</div>
                            <div class="item-meta">
                                <span class="item-price">${itemTotal.toFixed(2)} EGP</span>
                                <span class="item-quantity">
                                    ${isRTL ? 'الكمية:' : 'Qty:'} ${item.quantity || 1}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // تحديث العناصر
        cartItemsContainer.innerHTML = cartItemsHTML;
        subtotalElement.textContent = `${subtotal.toFixed(2)} EGP`;
        totalAmountElement.textContent = `${subtotal.toFixed(2)} EGP`;
        totalAmountInput.value = subtotal;
        cartDataInput.value = JSON.stringify(cart);
    }

    // إدارة نية التبرع
    intentionOptions.forEach(option => {
        option.addEventListener('click', function() {
            // إزالة التحديد من جميع الخيارات
            intentionOptions.forEach(opt => opt.classList.remove('selected'));

            // إضافة التحديد للخيار المختار
            this.classList.add('selected');

            const intention = this.dataset.intention;
            intentionTypeInput.value = intention;

            // إظهار/إخفاء مربع النص للنية المخصصة
            if (intention === 'custom') {
                customIntentionTextarea.style.display = 'block';
                customIntentionTextarea.required = true;
                customIntentionTextarea.focus();
            } else {
                customIntentionTextarea.style.display = 'none';
                customIntentionTextarea.required = false;
                customIntentionTextarea.value = intentionTranslations[intention] || '';
            }
        });
    });

    // التحقق من صحة النموذج
    checkoutForm.addEventListener('submit', function(e) {
        e.preventDefault();

        // التحقق من بيانات السلة
        if (cart.length === 0) {
            showError(isRTL ? 'السلة فارغة. يرجى إضافة تبرعات قبل المتابعة.' : 'Your cart is empty. Please add donations before proceeding.');
            return;
        }

        // التحقق من البيانات الشخصية
        const name = document.getElementById('donorName').value.trim();
        const email = document.getElementById('donorEmail').value.trim();
        const phone = document.getElementById('donorPhone').value.trim();

        if (!name || !email || !phone) {
            showError(isRTL ? 'يرجى ملء جميع الحقول المطلوبة' : 'Please fill all required fields');
            return;
        }

        // التحقق من صحة البريد الإلكتروني
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showError(isRTL ? 'يرجى إدخال بريد إلكتروني صحيح' : 'Please enter a valid email address');
            return;
        }


        // التحقق من نية التبرع المخصصة
        if (intentionTypeInput.value === 'custom' && !customIntentionTextarea.value.trim()) {
            showError(isRTL ? 'يرجى كتابة نية التبرع' : 'Please write your donation intention');
            return;
        }

        // إضافة تأثير التحميل
        submitBtn.classList.add('loading');
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
            <span>${isRTL ? 'جاري المعالجة...' : 'Processing...'}</span>
            <i class="fas fa-spinner"></i>
        `;

        // إرسال النموذج
        setTimeout(() => {
            this.submit();
        }, 1500);
    });

    // عرض رسالة خطأ
    function showError(message) {
        // إزالة أي رسائل خطأ سابقة
        const existingAlert = document.querySelector('.checkout-alerts');
        if (existingAlert) {
            existingAlert.remove();
        }

        // إنشاء رسالة الخطأ الجديدة
        const alertHTML = `
            <div class="checkout-alerts">
                <div class="alert-box alert-danger">
                    <div class="alert-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="alert-content">
                        <strong>${message}</strong>
                    </div>
                </div>
            </div>
        `;

        // إضافة الرسالة في أعلى الصفحة
        const checkoutPage = document.querySelector('.checkout-page');
        checkoutPage.insertAdjacentHTML('afterbegin', alertHTML);

        // تمرير للرسالة
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }


    // تحديث عند التحميل
    updateOrderSummary();

    // التأكد من وجود قيمة في الحقل المخفي
    if (cart.length > 0) {
        cartDataInput.value = JSON.stringify(cart);
    }
});
</script>
{% endblock %}